<script>
  let allData = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Server
  let myChart = null;

  // --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Flatpickr ---
  const fpMain = flatpickr("#datePicker", {
    locale: "th", dateFormat: "Y-m-d", altInput: true, altFormat: "j M Y",
    defaultDate: new Date(), disableMobile: "true"
  });

  // ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
  const now = new Date();
  const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
  const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);

  const fpStart = flatpickr("#startDate", {
    locale: "th", dateFormat: "Y-m-d", defaultDate: firstDay,
    onChange: () => filterAndRender()
  });

  const fpEnd = flatpickr("#endDate", {
    locale: "th", dateFormat: "Y-m-d", defaultDate: lastDay,
    onChange: () => filterAndRender()
  });

  // ‡πÇ‡∏´‡∏•‡∏î Link ‡∏Ç‡∏≠‡∏á Sheet ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°
  google.script.run.withSuccessHandler(url => {
    document.getElementById('sheet-link').href = url;
  }).getSpreadsheetUrl();

  // --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ---
  function switchPage(pageId, navElement) {
    document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    navElement.classList.add('active');

    if(pageId === 'page-stats') {
      loadDashboard();
    }
  }

  // --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
  function handleFormSubmit(formObject) {
    event.preventDefault();
    const btn = document.getElementById('submit-btn');
    const originalText = btn.innerText;
    btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£... ü•ö'; btn.disabled = true;

    google.script.run.withSuccessHandler(function(response) {
        const msg = document.getElementById('message');
        msg.innerText = response; msg.style.display = 'block';
        resetForm();
        btn.innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ üç≥'; btn.disabled = false;
        setTimeout(() => { msg.style.display = 'none'; }, 3000);
      }).saveData(formObject);
  }

  function resetForm() {
    const form = document.getElementById('myForm');
    form.reset();
    document.getElementById('row_index').value = "";
    document.getElementById('form-title').innerText = "üç≥ ‡∏à‡∏î‡∏ö‡∏¥‡∏•‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏Ç‡πà";
    document.getElementById('submit-btn').innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ üç≥";
    document.getElementById('cancel-edit').style.display = "none";
    fpMain.setDate(new Date());
  }

  // --- 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Dashboard ---
  function loadDashboard() {
    document.getElementById('recentList').innerHTML = '<li class="list-group-item text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</li>';
    google.script.run.withSuccessHandler(data => {
      allData = data;
      filterAndRender();
    }).getDataForDashboard();
  }

  // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà "DD/MM/YYYY" ‡∏û.‡∏®. ‡πÄ‡∏õ‡πá‡∏ô JS Date
  function parseThaiDate(dateStr) {
    const parts = dateStr.split("/");
    if (parts.length !== 3) return null;
    const d = parseInt(parts[0]);
    const m = parseInt(parts[1]) - 1;
    const y = parseInt(parts[2]) - 543;
    return new Date(y, m, d);
  }

  function filterAndRender() {
    const start = fpStart.selectedDates[0];
    const end = fpEnd.selectedDates[0];
    end.setHours(23, 59, 59);

    let filtered = allData.filter(item => {
      const itemDate = parseThaiDate(item.values[0]);
      return itemDate >= start && itemDate <= end;
    });

    renderDashboard(filtered);
  }

  function renderDashboard(data) {
    let income = 0;
    let expense = 0;
    let categories = {};
    let recentHtml = '';

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
    const sortedData = [...data].reverse();

    sortedData.forEach(item => {
        let row = item.values;
        let type = row[1];
        let cat = row[2];
        let amount = parseFloat(String(row[4]).replace(/,/g, ''));
        if (isNaN(amount)) amount = 0;

        if (type === '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö') {
            income += amount;
        } else if (type === '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢') {
            expense += amount;
        }

        if (categories[cat]) { categories[cat] += amount; } 
        else { categories[cat] = amount; }
        
        recentHtml += `<li class="list-group-item d-flex justify-content-between align-items-center px-1">
          <div style="flex: 1;">
            <div class="d-flex align-items-center">
              <span class="badge bg-light text-dark border me-2" style="font-size:0.7rem;">${row[0]}</span> 
              <span style="font-weight:600; color:#5D4037;">${cat}</span>
            </div>
            <div class="text-muted small ms-1">${row[3] || '-'}</div>
          </div>
          <div class="text-end">
            <div style="color:${type === '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' ? '#F39C12' : '#E67E22'}; font-weight:700;">
              ${type === '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' ? '+' : '-'}${amount.toLocaleString()}
            </div>
            <button class="btn btn-sm text-primary p-0" onclick="editItem(${item.index})">
              <i class="bi bi-pencil-square"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            </button>
          </div>
        </li>`;
    });

    document.getElementById('totalIncome').innerText = income.toLocaleString();
    document.getElementById('totalExpense').innerText = expense.toLocaleString();
    document.getElementById('totalBalance').innerText = (income - expense).toLocaleString();
    document.getElementById('itemCount').innerText = data.length;
    document.getElementById('recentList').innerHTML = recentHtml || '<li class="list-group-item text-center text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</li>';

    renderChart(categories);
  }

  // --- 5. ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ---
  function editItem(index) {
    const item = allData.find(d => d.index === index);
    if (!item) return;

    const row = item.values;
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤
    switchPage('page-add', document.getElementById('nav-add'));
    
    // ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
    document.getElementById('row_index').value = index;
    document.getElementById('form-title').innerText = "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£";
    document.getElementById('submit-btn').innerText = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ üç≥";
    document.getElementById('cancel-edit').style.display = "block";
    
    // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
    if (row[1] === '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö') document.getElementById('income').checked = true;
    else document.getElementById('expense').checked = true;

    // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÅ‡∏õ‡∏•‡∏á ‡∏û.‡∏®. ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®. ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö flatpickr)
    const dateObj = parseThaiDate(row[0]);
    fpMain.setDate(dateObj);

    // ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
    document.getElementById('category').value = row[2];
    document.getElementById('detail').value = row[3];
    document.getElementById('amount').value = row[4];
  }

  function renderChart(categories) {
    const ctx = document.getElementById('expenseChart').getContext('2d');
    const labels = Object.keys(categories);
    const values = Object.values(categories);
    
    const colorMap = {
      'Home (BBL)': '#F1C40F', 'Lineman (Kbank)': '#82E0AA', 'Shopee (TTB)': '#F39C12',
      'Grab (Kbank)': '#F7DC6F', '‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (‡∏ó‡∏∏‡∏ô)': '#E74C3C', '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ': '#D35400'
    };
    const fallbackColors = ['#FFC300', '#FF5733', '#DAF7A6', '#AED6F1'];
    let finalColors = labels.map((l, i) => colorMap[l] || fallbackColors[i % fallbackColors.length]);

    if (myChart) { myChart.destroy(); }
    myChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{ data: values, backgroundColor: finalColors, borderWidth: 2, borderColor: '#ffffff' }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { 
              legend: { position: 'bottom', labels: { font: { family: 'Kanit', size: 10 }, boxWidth: 10 } } 
            }
        }
    });
  }
</script>
